# CLAUDE.md

Repository context for future LLM contributors.

## Stack and structure

- Next.js 16 App Router with React 19.
- Firebase client SDK used directly from browser components (no API routes).
- Every page in `app/` is a client component (`'use client'`) except layout shell.
- Path alias: `@/*` (configured in `jsconfig.json`).

## Core commands

- `npm run dev` — uses Webpack (`next dev --webpack`); this is the expected local dev path.
- `npm run lint` — ESLint flat config.
- `npm run build` — production build.
- `npm test` — Jest (light usage currently).

Admin scripts (require `serviceAccountKey.json`):

- `node scripts/reset-database.js` (destructive, interactive confirm).
- `node scripts/weekly-reset.js [--dry-run] [--admin-email=...]`.
- `node scripts/seed-sports-markets.js --sport=<sport> [--dry-run]`.
- `node scripts/delete-sports-markets.js [--dry-run]` — refunds open/locked bets, then deletes all `autoGenerated: true` markets.
- `node scripts/backfill-oracle-scores.js [--dry-run]` — recomputes oracle scores for all users from resolved markets.
- `node scripts/export-waitlist.js [--csv] [--count]` — exports waitlist emails from Firestore.
- `node scripts/migrate-marketplace-null.js`.

## Current app model

Two scopes exist everywhere:

1. Global markets: `marketplaceId == null`
2. Private marketplace markets: `marketplaceId` is a marketplace document id

Many query/rules issues come from mixing these scopes incorrectly.

### Status model

`utils/marketStatus.js` defines:

- `OPEN`
- `LOCKED`
- `RESOLVED`
- `CANCELLED`

Trade actions should only occur when `isTradeableMarket(market)` is true (currently `OPEN` only).

### LMSR model

`utils/lmsr.js` is source of truth for pricing and share math:

- `calculateBet`
- `calculateSell`
- `getPrice`

Do not duplicate LMSR logic in pages.

## Firestore rules and implementation constraints

Read `firestore.rules` before adding queries. The critical constraints:

- `markets`, `bets`, `comments`, `newsItems` are read-gated by marketplace scope logic (`canReadMarketplaceScoped`).
- Global reads work for everyone when `resource.data.marketplaceId` is null.
- Marketplace reads require membership/creator/admin.
- `users`, `displayNames`, `weeklySnapshots` are broadly readable.
- `notifications` and `marketRequests` are auth and ownership constrained.
- `waitlist` allows unauthenticated create/update (email string ≤254 chars); admin-only read/delete.

### Query safety rule (important)

For `bets/comments/newsItems`, always include marketplace scope in query filters where practical:

- Global pages: `where('marketplaceId', '==', null)`
- Marketplace pages: `where('marketplaceId', '==', marketplaceId)`

If omitted, Firestore may reject with `permission-denied` because query could include inaccessible docs.

## Indexes and query patterns

`firestore.indexes.json` already includes common multi-field indexes, including:

- `bets`: `(marketplaceId, marketId, timestamp desc)` and `(marketplaceId, userId, timestamp desc)`
- `markets`: marketplace/status/resolution/createdAt variants
- `comments` and `newsItems`: `(marketId, timestamp desc)` (not marketplace-scoped variants)

Because of current indexes:

- Some scoped reads use `orderBy('timestamp', 'desc')` then reverse in memory for ascending display.
- Some comment/news reads fetch with filters + `limit` and then sort client-side.

If you add query combinations, update `firestore.indexes.json` accordingly.

## Auth and access patterns

- Google auth restricted to Cornell domain in two places:
  - `lib/firebase.js` provider `hd: 'cornell.edu'`
  - `app/login/page.js` email suffix check
- Admin is hardcoded by email and duplicated in multiple files + rules.
  - If admin list changes, update all references plus `firestore.rules`.
- Marketplace membership doc id is deterministic:
  - `toMarketplaceMemberId(marketplaceId, userId)` => `${marketplaceId}_${userId}`

## Launch gate (temporary but active)

Launch gate is implemented and currently active:

- Component: `app/components/LaunchGate.js`
- Wrapper: `app/layout.js` wraps `{children}` with `<LaunchGate>`.
- `Navigation` remains mounted in layout, but gate uses fixed overlay (`z-index: 9999`) to block interaction/visibility.
- Gate also includes an email sign-up form that writes to the `waitlist` Firestore collection (email as doc ID for deduplication).

Env vars used:

- `NEXT_PUBLIC_LAUNCH_PASSWORD`
- `NEXT_PUBLIC_LAUNCH_TIMESTAMP`

Current default/fallback timestamp in code is `1771855200000` (Mon Feb 23, 2026 9:00 AM EST).

Remove post-launch by:

1. Unwrapping `children` in layout
2. Deleting `LaunchGate.js`
3. Removing launch env vars

## Data and UX conventions

- Weekly baseline is `$1000` for global trading.
- Marketplace defaults (`utils/marketplace.js`):
  - starting balance `500`
  - default `b` `50`
  - reset mode `WEEKLY`
- Display names are managed with claim-key docs in `displayNames` and normalized uniqueness.
- Portfolio/leaderboard math centralizes in:
  - `utils/portfolio.js`
  - `utils/marketplacePortfolio.js`

### User document fields

New users get these fields at creation (set in both `app/login/page.js` and `app/onboarding/page.js`):

- `weeklyRep: 1000` — resets weekly
- `lifetimeRep: 0` — all-time P&L, never resets
- `oracleScore: 0` — all-time prediction accuracy score (see below)

### Oracle Score

`utils/oracleScore.js` computes an all-time prediction accuracy metric (global scope only):

- Formula: `netShares × (1 - avgEntryPrice)` on the winning side per market
- `avgEntryPrice = Σ(abs(amount) / shares * shares) / totalBuyShares` — weighted avg entry price
- Wrong-side bets and refunded bets earn 0
- Score is denormalized to `user.oracleScore` via `increment()` on every market resolution in `app/admin/page.js`
- Displayed on leaderboard (all-time tab), user profile, and own profile pages
- Run `scripts/backfill-oracle-scores.js` after any bulk resolution or to seed historical data
- Tests: `utils/__tests__/oracleScore.test.js`

### Markets: resolution date

Markets have an optional `resolutionDate` field (Firestore `Date`). Admins can set it at creation time and edit it on existing open markets via the admin panel. Displayed on the market detail page.

## Known implementation gotchas

- Do not log Firebase env vars/API keys in client code.
- Avoid broad unauthenticated reads on protected collections.
- Keep homepage and market-page fetches resilient: one failed subquery should not blank the whole page.
- `next/font/google` fetches at build time; offline/sandboxed builds can fail even if code is fine.
- A legacy component `app/components/navbar.js` exists; primary nav is `app/components/Navigation.js`.

## Recent incidents + fixes

- `orderBy` runtime error in `utils/marketplaceClient.js`:
  - Cause: `orderBy(...)` used without importing from Firestore.
  - Fix: import `orderBy` in `utils/marketplaceClient.js`.

- Homepage warning banner (`Unable to load latest market data...`) showing unexpectedly:
  - Cause: invalid/fragile Firestore query combinations and single catch block failing the whole page fetch.
  - Fix: split homepage data fetch into isolated `try/catch` blocks and simplify resolved-market fetching to safer query + client sort.

- Logged-out users seeing many `Missing or insufficient permissions` console errors:
  - Cause: public pages querying `bets/comments/newsItems` without marketplace scope filters or before access context settled.
  - Fix:
    - Added `where('marketplaceId', '==', null)` on global/public reads.
    - Added scoped marketplace filters on market detail page reads.
    - Gated market-detail dependent reads behind market access context.
    - Suppressed expected `permission-denied` noise where it is non-actionable.

- Market page had a non-functional “Activity” tab label:
  - Cause: static UI text with no state/content.
  - Fix: removed dead tab label to avoid misleading UI.

- Launch gate timestamp mismatch:
  - Cause: `1740319200000` corresponds to Feb 23, 2025, not 2026.
  - Fix: use `1771855200000` for Mon Feb 23, 2026 9:00 AM EST.

- Oracle badge appearing on P&L tab's #1:
  - Cause: badge condition checked `index === 0` regardless of active tab.
  - Fix: added `!isPnl` guard so oracle badge only shows on Oracle tab's #1.

- `oracleScore` missing from onboarding fallback:
  - Cause: `defaultProfileForUser()` in `app/onboarding/page.js` didn't include `oracleScore: 0`.
  - Fix: added the field to match the login-time doc shape.

## Suggested checklist before/after changes

Before:

- Check rules compatibility for new Firestore queries.
- Reuse utility modules (LMSR, portfolio, marketplace helpers) rather than reimplementing.

After:

- Run `npm run lint`.
- If query shapes changed, check/update `firestore.indexes.json`.
- Smoke test logged-out and logged-in flows for permission-denied console noise.
